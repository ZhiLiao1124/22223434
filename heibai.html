<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>HeiBai AI</title>
<meta property="og:title" content="HeiBai AI">
<meta property="og:description" content="Chat with HeiBai AI, your personal AI assistant, and explore powerful AI tools!">
<meta property="og:image" content="">
<meta property="og:url" content="">
<meta property="og:type" content="website">
<meta property="og:site_name" content="HeiBai AI">
<meta name="theme-color" content="#00a67e">
<meta name="color-scheme" content="light dark" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://js.puter.com/v2/"></script>

<style>
:root {
  --bg: #ffffff;
  --panel: #f7f7f8;
  --elev: #ffffff;
  --text: #374151;
  --sub: #6b7280;
  --accent: #00a67e;
  --accent-weak: #d1fae5;
  --border: #e5e7eb;
  --user: #00a67e;
  --bot: #00a67e;
  --danger: #ef4444;
  --muted: #9ca3af;
  --bubble: #f9fafb;
  --bubble-user: #dcfce7;
  --code: #f3f4f6;
  --kbd: #f9fafb;
  --shadow: 0 2px 8px rgba(0,0,0,0.08);
  --shadow-lg: 0 10px 25px rgba(0,0,0,0.15);
  --sidebar-width: 280px;
  --radius: 8px;
  --radius-lg: 12px;
  --transition: all 0.2s ease;
  --font-mono: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
}

body.dark {
  --bg: #111827;
  --panel: #1f2937;
  --elev: #374151;
  --text: #f9fafb;
  --sub: #d1d5db;
  --accent: #10b981;
  --accent-weak: #065f46;
  --border: #374151;
  --user: #10b981;
  --bot: #10b981;
  --danger: #ef4444;
  --muted: #9ca3af;
  --bubble: #374151;
  --bubble-user: #065f46;
  --code: #1f2937;
  --kbd: #374151;
  --shadow: 0 4px 16px rgba(0,0,0,0.25);
  --shadow-lg: 0 15px 35px rgba(0,0,0,0.3);
}

* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}

html, body {
  height: 100%;
}

body {
  background: var(--bg);
  color: var(--text);
  font: 14px/1.6 -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  display: grid;
  grid-template-columns: var(--sidebar-width) 1fr;
  grid-template-rows: 1fr;
  transition: all 0.2s ease;
}

.sidebar {
  background: var(--panel);
  border-right: 1px solid var(--border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.sidebar-header {
  padding: 16px;
  border-bottom: 1px solid var(--border);
}

.new-chat-btn {
  width: 100%;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 12px 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 8px;
  transition: all 0.2s ease;
}

.new-chat-btn:hover {
  background: color-mix(in srgb, var(--accent) 90%, black);
}

.sidebar-content {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
}

.chat-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  margin-bottom: 4px;
}

.chat-item:hover {
  background: var(--elev);
}

.chat-item.active {
  background: var(--accent-weak);
  color: var(--accent);
}

.chat-title {
  flex: 1;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  font-size: 14px;
}

.chat-delete {
  opacity: 0;
  background: none;
  border: none;
  color: var(--muted);
  cursor: pointer;
  padding: 4px;
  border-radius: 4px;
  transition: all 0.15s ease;
}

.chat-item:hover .chat-delete {
  opacity: 1;
}

.chat-delete:hover {
  background: var(--danger);
  color: white;
}

.sidebar-footer {
  padding: 16px;
  border-top: 1px solid var(--border);
}

.footer-links {
  display: flex;
  flex-direction: column;
  gap: 8px;
  font-size: 12px;
}

.footer-link {
  color: var(--muted);
  text-decoration: none;
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 8px;
  border-radius: 6px;
  transition: all 0.15s ease;
}

.footer-link:hover {
  color: var(--text);
  background: var(--elev);
}

.main-content {
  display: flex;
  flex-direction: column;
  height: 100vh;
}

.chat-header {
  background: var(--panel);
  border-bottom: 1px solid var(--border);
  padding: 16px 24px;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.chat-title-header {
  font-weight: 600;
  font-size: 16px;
}

.header-actions {
  display: flex;
  gap: 8px;
}

.icon-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--text);
  border-radius: 8px;
  padding: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  width: 36px;
  height: 36px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.icon-btn:hover {
  background: var(--elev);
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  padding: 24px;
  scroll-behavior: smooth;
}

.message {
  max-width: 800px;
  margin: 0 auto 32px auto;
  display: flex;
  gap: 16px;
}

.message-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  flex-shrink: 0;
}

.message-avatar.user {
  background: var(--accent);
  color: white;
}

.message-avatar.bot {
  background: var(--bot);
  color: white;
}

.message-content {
  flex: 1;
  line-height: 1.6;
}

.message.user .message-content {
  background: var(--bubble-user);
  padding: 16px;
  border-radius: 16px 16px 4px 16px;
  border: 1px solid var(--border);
}

.message.bot .message-content {
  padding: 16px 0;
}

.message-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
  opacity: 0;
  transition: opacity 0.15s ease;
}

.message:hover .message-actions {
  opacity: 1;
}

.action-btn {
  background: none;
  border: 1px solid var(--border);
  color: var(--muted);
  padding: 4px 8px;
  border-radius: 6px;
  font-size: 12px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.action-btn:hover {
  background: var(--elev);
  color: var(--text);
}

.chat-input-container {
  padding: 24px;
  background: var(--bg);
  border-top: 1px solid var(--border);
}

.chat-input-wrapper {
  max-width: 800px;
  margin: 0 auto;
  position: relative;
  background: var(--elev);
  border: 1px solid var(--border);
  border-radius: 12px;
  box-shadow: var(--shadow);
  overflow: hidden;
}

.chat-input {
  width: 100%;
  min-height: 24px;
  max-height: 200px;
  padding: 16px 50px 16px 16px;
  border: none;
  outline: none;
  background: transparent;
  color: var(--text);
  font: inherit;
  resize: none;
  line-height: 1.5;
}

.chat-input::placeholder {
  color: var(--muted);
}

.send-btn {
  position: absolute;
  right: 12px;
  bottom: 12px;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 6px;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: all 0.15s ease;
}

.send-btn:hover {
  background: color-mix(in srgb, var(--accent) 90%, black);
}

.send-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.input-hint {
  text-align: center;
  font-size: 12px;
  color: var(--muted);
  margin-top: 12px;
}

pre {
  background: var(--code);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 16px;
  overflow-x: auto;
  position: relative;
}

code {
  font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
  font-size: 13px;
}

.copy-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  background: var(--elev);
  border: 1px solid var(--border);
  color: var(--text);
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  cursor: pointer;
  opacity: 0;
  transition: opacity 0.15s ease;
}

pre:hover .copy-btn {
  opacity: 1;
}

.typing-indicator {
  display: inline-flex;
  gap: 4px;
  align-items: center;
  padding: 16px 0;
}

.typing-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: var(--accent);
  animation: typing 1.4s infinite;
}

.typing-dot:nth-child(2) { animation-delay: 0.2s; }
.typing-dot:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing {
  0%, 60%, 100% { opacity: 0.3; transform: translateY(0); }
  30% { opacity: 1; transform: translateY(-4px); }
}

@keyframes slideInRight {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

@keyframes slideOutRight {
  from {
    transform: translateX(0);
    opacity: 1;
  }
  to {
    transform: translateX(100%);
    opacity: 0;
  }
}

html {
  scroll-behavior: smooth;
}

*:focus {
  outline: 2px solid var(--accent);
  outline-offset: 2px;
}

button:focus,
input:focus,
textarea:focus,
select:focus {
  outline: none;
  box-shadow: 0 0 0 2px var(--accent);
}

.loading {
  opacity: 0.6;
  pointer-events: none;
}

.loading::after {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 20px;
  height: 20px;
  margin: -10px 0 0 -10px;
  border: 2px solid var(--border);
  border-top: 2px solid var(--accent);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

.logo-container {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
}

.logo {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, #00a67e, #059669);
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: bold;
  font-size: 18px;
}

.logo-text {
  font-weight: 700;
  font-size: 18px;
  color: var(--text);
}

.modal-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 2000;
  animation: fadeIn 0.2s ease;
}

.modal-content {
  background: var(--bg);
  border-radius: var(--radius-lg);
  padding: 0;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow: hidden;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideUp {
  from { 
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to { 
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 24px 24px 0;
  margin-bottom: 20px;
}

.modal-header h3 {
  margin: 0;
  font-size: 20px;
  font-weight: 600;
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  cursor: pointer;
  color: var(--muted);
  padding: 0;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
  border-radius: 50%;
  transition: var(--transition);
}

.modal-close:hover {
  background: var(--elev);
  color: var(--text);
}

.settings-tabs {
  display: flex;
  border-bottom: 1px solid var(--border);
  margin-bottom: 24px;
  padding: 0 24px;
}

.settings-tab {
  background: none;
  border: none;
  padding: 12px 16px;
  cursor: pointer;
  color: var(--sub);
  font-weight: 500;
  border-bottom: 2px solid transparent;
  transition: var(--transition);
}

.settings-tab.active {
  color: var(--accent);
  border-bottom-color: var(--accent);
}

.settings-tab:hover {
  color: var(--text);
}

.settings-content {
  padding: 0 24px 24px;
  max-height: 400px;
  overflow-y: auto;
}

.settings-panel {
  display: none;
}

.settings-panel.active {
  display: block;
  animation: fadeIn 0.2s ease;
}

.form-group {
  margin-bottom: 20px;
}

.form-label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--text);
  font-size: 14px;
}

.form-input {
  width: 100%;
  padding: 12px;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--elev);
  color: var(--text);
  font: inherit;
  transition: var(--transition);
}

.form-input:focus {
  outline: none;
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-weak);
}

.form-help {
  display: block;
  margin-top: 4px;
  font-size: 12px;
  color: var(--muted);
}

.form-check {
  display: flex;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 14px;
}

.form-check input[type="checkbox"] {
  margin: 0;
}

.theme-options {
  display: flex;
  gap: 16px;
}

.theme-option {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 8px;
  cursor: pointer;
  font-size: 12px;
}

.theme-option input[type="radio"] {
  display: none;
}

.theme-preview {
  width: 48px;
  height: 32px;
  border-radius: var(--radius);
  border: 2px solid var(--border);
  transition: var(--transition);
}

.theme-preview.light {
  background: linear-gradient(135deg, #ffffff, #f3f4f6);
}

.theme-preview.dark {
  background: linear-gradient(135deg, #1f2937, #374151);
}

.theme-preview.auto {
  background: linear-gradient(135deg, #ffffff 50%, #1f2937 50%);
}

.theme-option input[type="radio"]:checked + .theme-preview {
  border-color: var(--accent);
  box-shadow: 0 0 0 3px var(--accent-weak);
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: var(--radius);
  font-weight: 500;
  cursor: pointer;
  transition: var(--transition);
  font-size: 14px;
}

.btn.primary {
  background: var(--accent);
  color: white;
}

.btn.secondary {
  background: var(--elev);
  color: var(--text);
  border: 1px solid var(--border);
}

.btn.danger {
  background: var(--danger);
  color: white;
}

.btn:hover {
  transform: translateY(-1px);
  box-shadow: var(--shadow);
}

.btn:active {
  transform: translateY(0);
}

.modal-actions {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  padding: 20px 24px 24px;
  border-top: 1px solid var(--border);
  margin-top: 24px;
}

input[type="range"] {
  width: 100%;
  margin: 8px 0;
}

#fontSizeValue {
  font-size: 12px;
  color: var(--muted);
  margin-left: 8px;
}

.toast {
  position: fixed;
  top: 20px;
  right: 20px;
  padding: 12px 20px;
  background: var(--accent);
  color: white;
  border-radius: var(--radius);
  box-shadow: var(--shadow-lg);
  z-index: 3000;
  animation: slideInRight 0.3s ease;
}

.toast.error {
  background: var(--danger);
}

/* Áü•ËØÜÂ∫ìÁÆ°ÁêÜÊ†∑Âºè */
.knowledge-status {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  margin-bottom: 16px;
}

.status-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.status-item:last-child {
  margin-bottom: 0;
}

.status-label {
  font-weight: 500;
  color: var(--sub);
}

.status-value {
  font-weight: 600;
  color: var(--text);
}

.knowledge-files {
  max-height: 300px;
  overflow-y: auto;
  border: 1px solid var(--border);
  border-radius: var(--radius);
  background: var(--panel);
}

.knowledge-file-item {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

.knowledge-file-item:last-child {
  border-bottom: none;
}

.file-name {
  font-weight: 600;
  color: var(--text);
  margin-bottom: 4px;
}

.file-description {
  font-size: 12px;
  color: var(--sub);
  margin-bottom: 4px;
}

.file-keywords {
  font-size: 11px;
  color: var(--muted);
}

.knowledge-stats {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}

.stat-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.stat-item:last-child {
  margin-bottom: 0;
}

.stat-label {
  font-weight: 500;
  color: var(--sub);
}

.stat-value {
  font-weight: 600;
  color: var(--accent);
}

.loading {
  text-align: center;
  padding: 20px;
  color: var(--sub);
}

.no-files {
  text-align: center;
  padding: 20px;
  color: var(--sub);
  font-style: italic;
}

/* Ë∞ÉËØïÈù¢ÊùøÊ†∑Âºè */
.debug-info {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
}

.debug-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.debug-label {
  font-weight: 500;
  color: var(--sub);
}

.debug-console {
  background: var(--code);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px;
  max-height: 200px;
  overflow-y: auto;
  font-family: var(--font-mono);
  font-size: 12px;
}

.console-line {
  margin-bottom: 4px;
  padding: 2px 0;
  border-bottom: 1px solid var(--border);
}

.console-line:last-child {
  border-bottom: none;
}

.btn.small {
  padding: 4px 8px;
  font-size: 11px;
  min-height: auto;
}

@media (max-width: 768px) {
  body {
    grid-template-columns: 1fr;
  }
  
  .sidebar {
    position: fixed;
    left: -100%;
    width: var(--sidebar-width);
    height: 100%;
    z-index: 1000;
    transition: left 0.3s ease;
  }
  
  .sidebar.open {
    left: 0;
  }
  
  .sidebar-header {
    padding-top: 50px;
  }
  
  .menu-toggle {
    display: block;
    position: fixed;
    top: 16px;
    left: 16px;
    z-index: 1001;
  }
}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <div class="logo-container">
            <div class="logo">H</div>
            <div class="logo-text">HeiBai AI</div>
        </div>
        <button class="new-chat-btn" id="newChatBtn">
            <i class="fas fa-plus"></i>
            New Chat
        </button>
    </div>
    
    <div class="sidebar-content" id="chatHistory">
    </div>
    
    <div class="sidebar-footer">
        <div class="footer-links">
            <a href="#" class="footer-link" id="settingsBtn">
                <i class="fas fa-cog"></i>
                Settings
            </a>
            <a href="https://discord.gg/XfbwjPSYJU" class="footer-link" target="_blank">
                <i class="fab fa-discord"></i>
                Join Discord
            </a>
            <a href="#" class="footer-link" id="clearAllBtn">
                <i class="fas fa-trash"></i>
                Clear All
            </a>
        </div>
    </div>
</div>

<div class="main-content">
    <div class="chat-header">
        <div class="chat-title-header" id="chatTitle">New Chat</div>
        <div class="header-actions">
            <button class="icon-btn" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
        </div>
    </div>
    
    <div class="chat-messages" id="chatMessages">
    </div>
    
    <div class="chat-input-container">
        <div class="chat-input-wrapper">
            <textarea 
                class="chat-input" 
                id="chatInput" 
                placeholder="Type a message..."
                rows="1"
            ></textarea>
            <button class="send-btn" id="sendBtn">
                <i class="fas fa-paper-plane"></i>
            </button>
        </div>
        <div class="input-hint">
            Press <strong>Enter</strong> to send, <strong>Shift + Enter</strong> for new line
        </div>
    </div>
</div>

<div class="modal-overlay" id="settingsModal">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Settings</h3>
            <button class="modal-close" id="closeSettings">&times;</button>
        </div>
        
        <div class="settings-tabs">
            <button class="settings-tab active" data-tab="api">API Settings</button>
            <button class="settings-tab" data-tab="appearance">Appearance</button>
            <button class="settings-tab" data-tab="knowledge">Áü•ËØÜÂ∫ì</button>
            <button class="settings-tab" data-tab="advanced">Advanced</button>
        </div>
        
        <div class="settings-content">
            <div class="settings-panel active" id="api-settings">
                <div class="form-group">
                    <label class="form-label" for="providerSelect">AI Provider</label>
                    <select class="form-input" id="providerSelect">
                        <option value="puter">Puter.js (ÂÖçË¥π)</option>
                        <option value="gemini">Google Gemini</option>
                        <option value="openai">OpenAI</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="modelSelect">Model</label>
                    <select class="form-input" id="modelSelect">
                    </select>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="apiKeyInput">Custom API Key</label>
                    <input 
                        type="password" 
                        class="form-input" 
                        id="apiKeyInput" 
                        placeholder="Leave empty to use default key pool"
                    >
                    <small class="form-help">Enter your personal API key for better stability</small>
                </div>
            </div>
            
            <div class="settings-panel" id="appearance-settings">
                <h3>Appearance Settings</h3>
                <div class="form-group">
                    <label for="themeToggle">Theme</label>
                    <div class="theme-options">
                        <label class="theme-option">
                            <input type="radio" name="theme" value="light" checked>
                            <span class="theme-preview light"></span>
                            <span>Light</span>
                        </label>
                        <label class="theme-option">
                            <input type="radio" name="theme" value="dark">
                            <span class="theme-preview dark"></span>
                            <span>Dark</span>
                        </label>
                        <label class="theme-option">
                            <input type="radio" name="theme" value="auto">
                            <span class="theme-preview auto"></span>
                            <span>Auto</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="fontSizeSlider">Font Size</label>
                    <div class="slider-container">
                        <input type="range" id="fontSizeSlider" min="12" max="20" value="14">
                        <span id="fontSizeValue">14px</span>
                    </div>
                </div>
            </div>
            
                    <div class="settings-panel" id="knowledge-settings">
            <h3>Áü•ËØÜÂ∫ìÁÆ°ÁêÜ</h3>
            
            <div class="form-group">
                <label>Áü•ËØÜÂ∫ìÁä∂ÊÄÅ</label>
                <div class="knowledge-status">
                    <div class="status-item">
                        <span class="status-label">Â∑≤Âä†ËΩΩÊñá‰ª∂:</span>
                        <span class="status-value" id="knowledgeFileCount">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Á¥¢ÂºïÂÖ≥ÈîÆËØç:</span>
                        <span class="status-value" id="knowledgeKeywordCount">0</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">ÊúÄÂêéÊõ¥Êñ∞:</span>
                        <span class="status-value" id="knowledgeLastUpdate">-</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Áü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°®</label>
                <div class="knowledge-files" id="knowledgeFilesList">
                    <div class="loading">Âä†ËΩΩ‰∏≠...</div>
                </div>
            </div>
            
            <div class="form-group">
                <button class="btn secondary" id="refreshKnowledgeBtn">
                    <i class="fas fa-refresh"></i> Âà∑Êñ∞Áü•ËØÜÂ∫ì
                </button>
                <button class="btn secondary" id="testKnowledgeBtn">
                    <i class="fas fa-test"></i> ÊµãËØïÁü•ËØÜÂ∫ì
                </button>
                <button class="btn secondary" id="debugKnowledgeBtn">
                    <i class="fas fa-bug"></i> Ë∞ÉËØï‰ø°ÊÅØ
                </button>
            </div>
            
            <div class="form-group">
                <label>Áü•ËØÜÂ∫ì‰ΩøÁî®ÁªüËÆ°</label>
                <div class="knowledge-stats" id="knowledgeStats">
                    <div class="stat-item">
                        <span class="status-label">Êú¨Ê¨°‰ºöËØù‰ΩøÁî®:</span>
                        <span class="stat-value" id="sessionUsage">0</span>
                    </div>
                    <div class="stat-item">
                        <span class="status-label">ÊÄª‰ΩøÁî®Ê¨°Êï∞:</span>
                        <span class="stat-value" id="totalUsage">0</span>
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label>Ë∞ÉËØï‰ø°ÊÅØ</label>
                <div class="debug-info" id="debugInfo">
                    <div class="debug-item">
                        <span class="debug-label">ÊéßÂà∂Âè∞Êó•Âøó:</span>
                        <button class="btn small" onclick="clearConsole()">Ê∏ÖÈô§</button>
                    </div>
                    <div class="debug-console" id="debugConsole">
                        <div class="console-line">Á≠âÂæÖÊìç‰Ωú...</div>
                    </div>
                </div>
            </div>
        </div>

            <div class="settings-panel" id="advanced-settings">
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" id="autoSaveCheckbox" checked>
                        <span>Auto-save conversations</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-check">
                        <input type="checkbox" id="streamResponseCheckbox">
                        <span>Stream responses (Experimental)</span>
                    </label>
                </div>
                
                <div class="form-group">
                    <button class="btn danger" id="clearDataBtn">Clear All Data</button>
                </div>
            </div>
        </div>
        
        <div class="modal-actions">
            <button class="btn secondary" id="cancelSettings">Cancel</button>
            <button class="btn primary" id="saveSettings">Save Settings</button>
        </div>
    </div>
</div>

<script>
const API_CONFIGS = {
    puter: {
        keys: ['free'],
        models: ['gpt-4o-mini', 'claude-3.5-haiku', 'llama-3.1-8b'],
        baseUrl: 'https://api.puter.com'
    },
    gemini: {
        keys: [
            'AIzaSyCeKe-0_aVgcL4TMyUhwQsWXtiHQxmIm4Q',
            'AIzaSyDx8a8QFBDxMN8c8h-L-qrSerCpAjAAUng',
            'AIzaSyAHeDk9eBmrXSNpb7MHYV0U5BFMhK629kQ',
            'AIzaSyDAeHwXUa-6tod2jBhJrSVbmw2KBa4lxoU',
            'AIzaSyBL5aaFetan2YHwrB-vgqmRr0W62DH4Qh4',
            'AIzaSyCihwhlVBdkCCZ8OXl4mKmh77u1m8dgU14',
            'AIzaSyAIX6q4NN19tCNhQLKTm5HbDQrYoxTuYW0',
            'AIzaSyDLOlg_XqMW3mJmYx17_ctJIPV3EQZa3p4',
            'AIzaSyCzSQZayCMcMIUtwWZBbWvtRkfMy-eZbvc',
            'AIzaSyA40By-TjbAIpyJQ8QXCPi8wfJl6Xj7MJU',
            'AIzaSyDOHXq2vcgAl_bQI0SDo4EXBDsUpmsBDSs',
            'AIzaSyDtJ9f8lrud97P50zShuM5xEm1ulKLQ7q8'
        ],
        models: ['gemini-1.5-flash', 'gemini-1.5-pro', 'gemini-1.0-pro'],
        baseUrl: 'https://generativelanguage.googleapis.com/v1beta/models'
    },
    openai: {
        keys: ['sk-your-openai-key-here'],
        models: ['gpt-4o-mini', 'gpt-4o', 'gpt-3.5-turbo'],
        baseUrl: 'https://api.openai.com/v1'
    }
};

let currentAPIKeyIndex = 0;
let currentProvider = 'gemini';
let currentModel = 'gemini-1.5-flash';
let conversations = JSON.parse(localStorage.getItem('heibai_conversations') || '[]');
let currentConversationId = localStorage.getItem('heibai_current_conversation');

// Áü•ËØÜÂ∫ìÁ≥ªÁªüÂèòÈáè
let knowledgeBase = [];
let knowledgeIndex = {};
let knowledgeUsageStats = {
    sessionUsage: 0,
    totalUsage: parseInt(localStorage.getItem('heibai_knowledge_total_usage') || '0')
};

document.addEventListener('DOMContentLoaded', function() {
    initializeApp();
});

function initializeApp() {
    loadSettings();
    loadKnowledgeBase(); // Âä†ËΩΩÁü•ËØÜÂ∫ì
    
    if (!conversations.length) {
        createNewConversation();
    }
    
    if (!currentConversationId && conversations.length > 0) {
        currentConversationId = conversations[0].id;
    }
    
    renderChatHistory();
    renderMessages();
    updateChatTitle();
    setupEventListeners();
    loadTheme();
    
    console.log('HeiBai AI initialized successfully');
    console.log('Knowledge base loaded:', knowledgeBase.length, 'files');
    
    if (!localStorage.getItem('heibai_welcome_shown')) {
        setTimeout(() => {
            showToast('Welcome to HeiBai AI! Press Ctrl+N to start a new chat', 'info');
            localStorage.setItem('heibai_welcome_shown', 'true');
        }, 1000);
    }
}

function loadSettings() {
    currentProvider = localStorage.getItem('heibai_provider') || 'gemini';
    currentModel = localStorage.getItem('heibai_model') || 'gemini-1.5-flash';
    
    const savedTheme = localStorage.getItem('heibai_theme') || 'light';
    setTheme(savedTheme);
    
    const savedFontSize = localStorage.getItem('heibai_font_size') || '14';
    document.documentElement.style.setProperty('--font-size', savedFontSize + 'px');
    
    const autoSave = localStorage.getItem('heibai_auto_save') !== 'false';
    const streamResponse = localStorage.getItem('heibai_stream_response') === 'true';
    
    document.getElementById('autoSaveCheckbox').checked = autoSave;
    document.getElementById('streamResponseCheckbox').checked = streamResponse;
    
    document.getElementById('fontSizeSlider').value = savedFontSize;
    document.getElementById('fontSizeValue').textContent = savedFontSize + 'px';
}

function setupEventListeners() {
    document.getElementById('sendBtn').addEventListener('click', sendMessage);
    document.getElementById('chatInput').addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            sendMessage();
        }
    });
    
    document.getElementById('chatInput').addEventListener('input', autoResizeTextarea);
    
    document.getElementById('newChatBtn').addEventListener('click', createNewConversation);
    
    document.getElementById('themeToggle').addEventListener('click', toggleTheme);
    
    document.getElementById('settingsBtn').addEventListener('click', openSettings);
    document.getElementById('cancelSettings').addEventListener('click', closeSettings);
    document.getElementById('saveSettings').addEventListener('click', saveSettings);
    document.getElementById('closeSettings').addEventListener('click', closeSettings);
    
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            switchSettingsTab(tabName);
        });
    });
    
    document.getElementById('providerSelect').addEventListener('change', updateModelOptions);
    
    document.querySelectorAll('input[name="theme"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
            setTheme(e.target.value);
        });
    });
    
    document.getElementById('fontSizeSlider').addEventListener('input', (e) => {
        const size = e.target.value;
        document.getElementById('fontSizeValue').textContent = size + 'px';
        document.documentElement.style.setProperty('--font-size', size + 'px');
    });
    
    document.getElementById('clearAllBtn').addEventListener('click', clearAllConversations);
    document.getElementById('clearDataBtn').addEventListener('click', clearAllData);
    
    // Áü•ËØÜÂ∫ìÁõ∏ÂÖ≥‰∫ã‰ª∂ÁõëÂê¨Âô®
    document.getElementById('refreshKnowledgeBtn').addEventListener('click', loadKnowledgeBase);
    document.getElementById('testKnowledgeBtn').addEventListener('click', testKnowledgeBase);
    document.getElementById('debugKnowledgeBtn').addEventListener('click', showDebugInfo);
    
    document.addEventListener('keydown', (e) => {
        if (e.ctrlKey || e.metaKey) {
            switch (e.key) {
                case 'n':
                    e.preventDefault();
                    createNewConversation();
                    break;
                case ',':
                    e.preventDefault();
                    openSettings();
                    break;
                case 'k':
                    e.preventDefault();
                    if (e.shiftKey) {
                        clearAllConversations();
                    }
                    break;
            }
        }
        
        if (e.key === 'Escape') {
            closeSettings();
        }
    });
}

function getCurrentAPIKey() {
    const config = API_CONFIGS[currentProvider];
    
    // Puter.js‰∏çÈúÄË¶ÅAPIÂØÜÈí•
    if (currentProvider === 'puter') {
        return null;
    }
    
    const key = config.keys[currentAPIKeyIndex % config.keys.length];
    currentAPIKeyIndex++;
    return key;
}

function getCurrentModel() {
    return currentModel;
}

function getCurrentProvider() {
    return currentProvider;
}

function createNewConversation() {
    const conversation = {
        id: Date.now().toString(),
        title: 'New Chat',
        messages: [],
        createdAt: new Date().toISOString()
    };
    
    conversations.unshift(conversation);
    currentConversationId = conversation.id;
    
    saveConversations();
    renderChatHistory();
    renderMessages();
    updateChatTitle();
}

function getCurrentConversation() {
    return conversations.find(conv => conv.id === currentConversationId) || conversations[0];
}

function saveConversations() {
    localStorage.setItem('heibai_conversations', JSON.stringify(conversations));
    localStorage.setItem('heibai_current_conversation', currentConversationId);
}

function renderChatHistory() {
    const historyContainer = document.getElementById('chatHistory');
    historyContainer.innerHTML = '';
    
    conversations.forEach(conv => {
        const chatItem = document.createElement('div');
        chatItem.className = `chat-item ${conv.id === currentConversationId ? 'active' : ''}`;
        
        chatItem.innerHTML = `
            <i class="fas fa-message"></i>
            <div class="chat-title">${conv.title}</div>
            <button class="chat-delete" onclick="deleteConversation('${conv.id}')">
                <i class="fas fa-trash"></i>
            </button>
        `;
        
        chatItem.addEventListener('click', (e) => {
            if (!e.target.closest('.chat-delete')) {
                switchConversation(conv.id);
            }
        });
        
        historyContainer.appendChild(chatItem);
    });
}

function switchConversation(conversationId) {
    currentConversationId = conversationId;
    saveConversations();
    renderChatHistory();
    renderMessages();
    updateChatTitle();
}

function deleteConversation(conversationId) {
    if (conversations.length <= 1) {
        alert('You need to keep at least one conversation');
        return;
    }
    
    if (!confirm('Are you sure you want to delete this conversation?')) return;
    
    conversations = conversations.filter(conv => conv.id !== conversationId);
    
    if (currentConversationId === conversationId) {
        currentConversationId = conversations[0].id;
    }
    
    saveConversations();
    renderChatHistory();
    renderMessages();
    updateChatTitle();
}

function updateChatTitle() {
    const conversation = getCurrentConversation();
    document.getElementById('chatTitle').textContent = conversation ? conversation.title : 'New Chat';
}

function renderMessages() {
    const messagesContainer = document.getElementById('chatMessages');
    const conversation = getCurrentConversation();
    
    messagesContainer.innerHTML = '';
    
    if (!conversation || !conversation.messages.length) {
        const welcomeMessage = document.createElement('div');
        welcomeMessage.className = 'message bot';
        welcomeMessage.innerHTML = `
            <div class="message-avatar bot">
                <i class="fas fa-robot"></i>
            </div>
            <div class="message-content">
                <p>üëã Welcome to HeiBai AI! How can I assist you today?</p>
            </div>
        `;
        messagesContainer.appendChild(welcomeMessage);
        return;
    }
    
    conversation.messages.forEach((message, index) => {
        const messageElement = createMessageElement(message, index);
        messagesContainer.appendChild(messageElement);
    });
    
    scrollToBottom();
}

function createMessageElement(message, index) {
    const messageDiv = document.createElement('div');
    messageDiv.className = `message ${message.role}`;
    
    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${message.role}`;
    avatar.innerHTML = message.role === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
    
    const content = document.createElement('div');
    content.className = 'message-content';
    content.innerHTML = formatMessage(message.content);
    
    const actions = document.createElement('div');
    actions.className = 'message-actions';
    
    if (message.role === 'assistant') {
        actions.innerHTML = `
            <button class="action-btn" onclick="copyMessage(${index})">
                <i class="fas fa-copy"></i> Copy
            </button>
            <button class="action-btn" onclick="regenerateMessage(${index})">
                <i class="fas fa-refresh"></i> Regenerate
            </button>
        `;
    } else {
        actions.innerHTML = `
            <button class="action-btn" onclick="editMessage(${index})">
                <i class="fas fa-edit"></i> Edit
            </button>
        `;
    }
    
    const contentWrapper = document.createElement('div');
    contentWrapper.appendChild(content);
    contentWrapper.appendChild(actions);
    
    messageDiv.appendChild(avatar);
    messageDiv.appendChild(contentWrapper);
    
    return messageDiv;
}

function formatMessage(content) {
    content = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/`(.*?)`/g, '<code>$1</code>')
        .replace(/\n/g, '<br>');
    
    content = content.replace(/```(\w+)?\n?([\s\S]*?)```/g, (match, lang, code) => {
        return `<pre><code>${code.trim()}</code><button class="copy-btn" onclick="copyCode(this)">Copy</button></pre>`;
    });
    
    return content;
}

function copyCode(button) {
    const code = button.previousElementSibling.textContent;
    navigator.clipboard.writeText(code).then(() => {
        button.textContent = 'Copied';
        setTimeout(() => {
            button.textContent = 'Copy';
        }, 2000);
    });
}

function copyMessage(index) {
    const conversation = getCurrentConversation();
    const message = conversation.messages[index];
    navigator.clipboard.writeText(message.content).then(() => {
        const btn = event.target.closest('.action-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied';
        setTimeout(() => {
            btn.innerHTML = originalText;
        }, 2000);
    });
}

function editMessage(index) {
    const conversation = getCurrentConversation();
    const message = conversation.messages[index];
    document.getElementById('chatInput').value = message.content;
    document.getElementById('chatInput').focus();
    autoResizeTextarea();
}

function regenerateMessage(index) {
    const conversation = getCurrentConversation();
    const userMessage = conversation.messages[index - 1];
    
    if (userMessage && userMessage.role === 'user') {
        conversation.messages = conversation.messages.slice(0, index);
        saveConversations();
        renderMessages();
        generateAIResponse(userMessage.content);
    }
}

function autoResizeTextarea() {
    const textarea = document.getElementById('chatInput');
    textarea.style.height = 'auto';
    textarea.style.height = Math.min(textarea.scrollHeight, 200) + 'px';
}

function scrollToBottom() {
    const messagesContainer = document.getElementById('chatMessages');
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

async function sendMessage() {
    try {
        const input = document.getElementById('chatInput');
        const message = input.value.trim();
        
        if (!message) return;
        
        const customApiKey = localStorage.getItem('heibai_custom_api_key');
        if (!customApiKey && !API_CONFIGS.gemini.keys.length) {
            openSettings();
            return;
        }
    
        const conversation = getCurrentConversation();
        setInputState(false);
        
        const userMessage = {
            role: 'user',
            content: message,
            timestamp: new Date().toISOString()
        };
        
        conversation.messages.push(userMessage);
        
        if (conversation.messages.length === 1) {
            conversation.title = generateConversationTitle(message);
        }
        
        input.value = '';
        autoResizeTextarea();
        
        saveConversations();
        renderChatHistory();
        renderMessages();
        
        try {
            await generateAIResponse(message);
        } catch (error) {
            hideTypingIndicator();
            
            let errorMessage = 'Sorry, there was an error processing your message.';
            if (error.message.includes('quota')) {
                errorMessage += ' API quota exceeded. Please try again later.';
            } else if (error.message.includes('network')) {
                errorMessage += ' Network connection issue. Please check your connection.';
            } else {
                errorMessage += ' Please try again later.';
            }
            
            showErrorMessage(errorMessage);
            console.error('Error:', error);
            
            conversation.messages.pop();
            renderMessages();
        }
        
        setInputState(true);
    } catch (error) {
        console.error('Error in sendMessage:', error);
        setInputState(true);
    }
}

async function generateAIResponse(userMessage) {
    const conversation = getCurrentConversation();
    
    showTypingIndicator();
    
    try {
        // Á°Æ‰øùÁü•ËØÜÂ∫ìÂ∑≤Âä†ËΩΩ
        if (knowledgeBase.length === 0) {
            console.log('Knowledge base not loaded, loading now...');
            await loadKnowledgeBase();
        }
        
        // ÊêúÁ¥¢Áü•ËØÜÂ∫ì
        const knowledgeResults = searchKnowledgeBase(userMessage);
        console.log('Knowledge search results:', knowledgeResults.length);
        console.log('Query:', userMessage);
        console.log('Results:', knowledgeResults.map(r => ({ fileName: r.fileName, relevance: r.relevance, matchType: r.matchType })));
        
        // ÁîüÊàêÂ¢ûÂº∫ÁöÑÊèêÁ§∫ËØç
        const enhancedPrompt = generateKnowledgePrompt(userMessage, knowledgeResults);
        console.log('Enhanced prompt length:', enhancedPrompt.length);
        
        // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞Áü•ËØÜÂ∫ìÁªìÊûúÔºåÂº∫Âà∂ÂåÖÂê´‰∏Ä‰∫õÂü∫Á°ÄÊñá‰ª∂
        let finalPrompt = enhancedPrompt;
        if (knowledgeResults.length === 0) {
            console.log('No knowledge base results found, including basic files...');
            const basicFiles = knowledgeBase.filter(item => 
                item.fileName.includes('README') || 
                item.fileName.includes('CLIENT_OPTIONS') ||
                item.fileName.includes('CALLBACKS')
            ).slice(0, 3);
            
            if (basicFiles.length > 0) {
                finalPrompt = `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑAIÂä©ÊâãÔºå‰∏ìÈó®Â∏ÆÂä©‰∫∫‰ª¨ÁºñÂÜôÁî®‰∫éBloxd.ioÊ∏∏ÊàèÁöÑ‰ª£Á†Å„ÄÇÂú®Bloxd.io‰∏≠Ôºå‰Ω†ÂèØ‰ª•Âú®‰ª£Á†ÅÂùó‰∏≠ÁºñÂÜô‰ª£Á†ÅÔºåÂè≥ÈîÆÁÇπÂáªËøêË°åÔºåËøòÂèØ‰ª•ÁºñÂÜôÂÆö‰πâÂèØÁºñËæëÂõûË∞ÉÂàóË°®ÁöÑWorld Code„ÄÇ

ÈáçË¶ÅÊåá‰ª§Ôºö
1. 100%Âü∫‰∫é‰ª•‰∏ãÁü•ËØÜÂ∫ìÊñáÊ°£‰ø°ÊÅØÂõûÁ≠îÈóÆÈ¢ò
2. ‰∏ìÈó®ÈíàÂØπBloxd.ioÊ∏∏ÊàèÁºñÁ®ãÊèê‰æõÂ∏ÆÂä©
3. Êèê‰æõÁöÑ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ªÂèØ‰ª•Âú®Bloxd.io‰∏≠ËøêË°å
4. ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ª‰ΩøÁî®‰ª£Á†ÅÂùóÊ†ºÂºè
5. Â¶ÇÊûúÁü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØÔºåËØ∑ÊòéÁ°ÆËØ¥Êòé"Áü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØ"

Áü•ËØÜÂ∫ìÊñáÊ°£‰ø°ÊÅØÔºö
${basicFiles.map((result, index) => `
${index + 1}. Êñá‰ª∂: ${result.fileName}
ÊèèËø∞: ${result.description}
ÂÜÖÂÆπÊëòË¶Å: ${result.content.substring(0, 600)}${result.content.length > 600 ? '...' : ''}
`).join('')}

Áî®Êà∑ÈóÆÈ¢ò: ${userMessage}

ÂõûÁ≠îË¶ÅÊ±ÇÔºö
1. ‰∏ìÈó®ÈíàÂØπBloxd.ioÊ∏∏ÊàèÁºñÁ®ãÊèê‰æõÂ∏ÆÂä©
2. Êèê‰æõÁöÑ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ªÂèØ‰ª•Âú®Bloxd.io‰∏≠ËøêË°å
3. ‰ª£Á†ÅÁ§∫‰æã‰ΩøÁî®\`\`\`‰ª£Á†ÅÂùó\`\`\`Ê†ºÂºè
4. Â¶ÇÊûúÁü•ËØÜÂ∫ì‰ø°ÊÅØ‰∏çË∂≥ÔºåÊòéÁ°ÆËØ¥Êòé"Áü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØ"

ËØ∑ÂºÄÂßãÂõûÁ≠îÔºö`;
            }
        }
        
        const aiResponse = await callAPI(currentProvider, currentModel, finalPrompt);
        
        const assistantMessage = {
            role: 'assistant',
            content: aiResponse,
            timestamp: new Date().toISOString(),
            knowledgeUsed: knowledgeResults.map(r => r.fileName) // ËÆ∞ÂΩï‰ΩøÁî®ÁöÑÁü•ËØÜÂ∫ìÊñá‰ª∂
        };
        
        conversation.messages.push(assistantMessage);
        saveConversations();
        
        hideTypingIndicator();
        renderMessages();
        
        // Êõ¥Êñ∞Áü•ËØÜÂ∫ì‰ΩøÁî®ÁªüËÆ°
        if (knowledgeResults.length > 0) {
            knowledgeUsageStats.sessionUsage++;
            knowledgeUsageStats.totalUsage++;
            localStorage.setItem('heibai_knowledge_total_usage', knowledgeUsageStats.totalUsage.toString());
            showToast(`Â∑≤‰ΩøÁî® ${knowledgeResults.length} ‰∏™Áü•ËØÜÂ∫ìÊñá‰ª∂`, 'info');
        } else {
            console.log('No knowledge base results found for query:', userMessage);
        }
        
    } catch (error) {
        console.error('Error generating AI response:', error);
        hideTypingIndicator();
        
        let errorContent = 'Sorry, I am unable to respond at the moment.';
        
        if (error.message.includes('quota')) {
            errorContent += ' API quota exceeded. Please try again later or use a custom API key.';
        } else if (error.message.includes('network') || error.message.includes('fetch')) {
            errorContent += ' Network connection issue. Please check your internet connection.';
        } else if (error.message.includes('401') || error.message.includes('403')) {
            errorContent += ' API key is invalid or expired. Please update it in settings.';
        } else {
            errorContent += ' Please try again later.';
        }
        
        const errorMessage = {
            role: 'assistant',
            content: errorContent,
            timestamp: new Date().toISOString()
        };
        
        conversation.messages.push(errorMessage);
        saveConversations();
        renderMessages();
    }
}

async function callAPI(provider, model, prompt) {
    switch (provider) {
        case 'puter':
            try {
                const response = await puter.ai.chat(model, prompt, {
                    temperature: 0.7,
                    max_tokens: 2048
                });
                return response;
            } catch (error) {
                throw new Error(`Puter.js API Error: ${error.message}`);
            }
            
        case 'gemini':
            try {
                const customApiKey = localStorage.getItem('heibai_custom_api_key');
                const apiKey = customApiKey || getCurrentAPIKey();
                
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${model}:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{
                                text: prompt
                            }]
                        }],
                        generationConfig: {
                            temperature: 0.7,
                            topK: 40,
                            topP: 0.95,
                            maxOutputTokens: 2048,
                        }
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.candidates || !data.candidates[0] || !data.candidates[0].content) {
                    throw new Error('Invalid API response format');
                }
                
                return data.candidates[0].content.parts[0].text;
            } catch (error) {
                throw error;
            }
            
        case 'openai':
            try {
                const customApiKey = localStorage.getItem('heibai_custom_api_key');
                const apiKey = customApiKey || getCurrentAPIKey();
                
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [{ role: 'user', content: prompt }],
                        temperature: 0.7,
                        max_tokens: 2048
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`API request failed: ${response.status} - ${response.statusText}`);
                }
                
                const data = await response.json();
                
                if (!data.choices || !data.choices[0] || !data.choices[0].message) {
                    throw new Error('Invalid API response format');
                }
                
                return data.choices[0].message.content;
            } catch (error) {
                throw error;
            }
            
        default:
            throw new Error(`Unsupported provider: ${provider}`);
    }
}

function showTypingIndicator() {
    const messagesContainer = document.getElementById('chatMessages');
    
    const typingDiv = document.createElement('div');
    typingDiv.className = 'message bot';
    typingDiv.id = 'typing-indicator';
    
    typingDiv.innerHTML = `
        <div class="message-avatar bot">
            <i class="fas fa-robot"></i>
        </div>
        <div class="message-content">
            <div class="typing-indicator">
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
                <div class="typing-dot"></div>
            </div>
        </div>
    `;
    
    messagesContainer.appendChild(typingDiv);
    scrollToBottom();
}

function hideTypingIndicator() {
    const typingIndicator = document.getElementById('typing-indicator');
    if (typingIndicator) {
        typingIndicator.remove();
    }
}

function toggleTheme() {
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    
    body.classList.toggle('dark');
    
    if (body.classList.contains('dark')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
        localStorage.setItem('heibai_theme', 'dark');
    } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
        localStorage.setItem('heibai_theme', 'light');
    }
}

function loadTheme() {
    const savedTheme = localStorage.getItem('heibai_theme');
    const body = document.body;
    const themeToggle = document.getElementById('themeToggle');
    
    if (savedTheme === 'dark') {
        body.classList.add('dark');
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
}

function openSettings() {
    const modal = document.getElementById('settingsModal');
    const apiKeyInput = document.getElementById('apiKeyInput');
    const providerSelect = document.getElementById('providerSelect');
    const modelSelect = document.getElementById('modelSelect');
    const fontSizeSlider = document.getElementById('fontSizeSlider');
    
    const customApiKey = localStorage.getItem('heibai_custom_api_key');
    const savedProvider = localStorage.getItem('heibai_provider') || 'gemini';
    const savedModel = localStorage.getItem('heibai_model') || 'gemini-1.5-flash';
    const savedTheme = localStorage.getItem('heibai_theme') || 'light';
    const savedFontSize = localStorage.getItem('heibai_font_size') || '14';
    
    apiKeyInput.value = customApiKey || '';
    providerSelect.value = savedProvider;
    modelSelect.value = savedModel;
    fontSizeSlider.value = savedFontSize;
    document.getElementById('fontSizeValue').textContent = savedFontSize + 'px';
    
    document.querySelector(`input[name="theme"][value="${savedTheme}"]`).checked = true;
    
    updateModelOptions();
    
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
    apiKeyInput.focus();
}

function closeSettings() {
    const modal = document.getElementById('settingsModal');
    modal.style.display = 'none';
    document.body.style.overflow = '';
}

function saveSettings() {
    const apiKey = document.getElementById('apiKeyInput').value.trim();
    const provider = document.getElementById('providerSelect').value;
    const model = document.getElementById('modelSelect').value;
    const theme = document.querySelector('input[name="theme"]:checked').value;
    const fontSize = document.getElementById('fontSizeSlider').value;
    const autoSave = document.getElementById('autoSaveCheckbox').checked;
    const streamResponse = document.getElementById('streamResponseCheckbox').checked;
    
    if (apiKey) {
        localStorage.setItem('heibai_custom_api_key', apiKey);
    } else {
        localStorage.removeItem('heibai_custom_api_key');
    }
    
    localStorage.setItem('heibai_provider', provider);
    localStorage.setItem('heibai_model', model);
    localStorage.setItem('heibai_theme', theme);
    localStorage.setItem('heibai_font_size', fontSize);
    localStorage.setItem('heibai_auto_save', autoSave);
    localStorage.setItem('heibai_stream_response', streamResponse);
    
    currentProvider = provider;
    currentModel = model;
    setTheme(theme);
    document.documentElement.style.setProperty('--font-size', fontSize + 'px');
    
    closeSettings();
    
    showToast('Settings saved successfully');
}

function showToast(message, type = 'success') {
    const toast = document.createElement('div');
    toast.className = `toast ${type === 'error' ? 'error' : ''}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.style.animation = 'slideOutRight 0.3s ease';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}

function showErrorMessage(message) {
    showToast(message, 'error');
}

function setInputState(enabled) {
    const input = document.getElementById('chatInput');
    const sendBtn = document.getElementById('sendBtn');
    
    if (input) input.disabled = !enabled;
    if (sendBtn) sendBtn.disabled = !enabled;
}

function generateConversationTitle(message) {
    const keywords = [
        'hello', 'hi', 'help', 'question', 'need', 'want', 'can',
        'how', 'what', 'why', 'where', 'when', 'who'
    ];
    
    const lowerMessage = message.toLowerCase();
    
    for (const keyword of keywords) {
        if (lowerMessage.includes(keyword)) {
            const cleanMessage = message.replace(/[^\w\s]/g, '').trim();
            const words = cleanMessage.split(/\s+/);
            const titleWords = words.slice(0, 3).join(' ');
            return titleWords.length > 10 ? titleWords.substring(0, 10) + '...' : titleWords || 'New Chat';
        }
    }
    
    const cleanMessage = message.replace(/[^\w\s]/g, '').trim();
    return cleanMessage.length > 10 ? cleanMessage.substring(0, 10) + '...' : cleanMessage || 'New Chat';
}

function clearAllConversations() {
    if (!confirm('Are you sure you want to clear all conversations? This cannot be undone.')) {
        return;
    }
    
    conversations = [];
    localStorage.removeItem('heibai_conversations');
    localStorage.removeItem('heibai_current_conversation');
    
    createNewConversation();
}

function switchSettingsTab(tabName) {
    document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
    });
    
    document.querySelectorAll('.settings-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabName}-settings`);
    });
    
    // Â¶ÇÊûúÂàáÊç¢Âà∞Áü•ËØÜÂ∫ìÈù¢ÊùøÔºåÊõ¥Êñ∞Áä∂ÊÄÅ
    if (tabName === 'knowledge') {
        updateKnowledgeStatus();
    }
}

function updateModelOptions() {
    const provider = document.getElementById('providerSelect').value;
    const modelSelect = document.getElementById('modelSelect');
    const models = API_CONFIGS[provider].models;
    
    modelSelect.innerHTML = '';
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model;
        option.textContent = model;
        modelSelect.appendChild(option);
    });
    
    const savedModel = localStorage.getItem('heibai_model');
    if (savedModel && models.includes(savedModel)) {
        modelSelect.value = savedModel;
    }
}

function setTheme(theme) {
    const body = document.body;
    
    if (theme === 'auto') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        body.classList.toggle('dark', prefersDark);
    } else {
        body.classList.toggle('dark', theme === 'dark');
    }
    
    const themeToggle = document.getElementById('themeToggle');
    if (body.classList.contains('dark')) {
        themeToggle.innerHTML = '<i class="fas fa-sun"></i>';
    } else {
        themeToggle.innerHTML = '<i class="fas fa-moon"></i>';
    }
    
    localStorage.setItem('heibai_theme', theme);
}

function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This will delete all conversations and settings.')) {
        localStorage.removeItem('heibai_conversations');
        localStorage.removeItem('heibai_current_conversation');
        localStorage.removeItem('heibai_custom_api_key');
        localStorage.removeItem('heibai_provider');
        localStorage.removeItem('heibai_model');
        localStorage.removeItem('heibai_theme');
        localStorage.removeItem('heibai_font_size');
        
        conversations = [];
        currentConversationId = null;
        
        createNewConversation();
        closeSettings();
    }
}

document.addEventListener('click', function(e) {
    const modal = document.getElementById('settingsModal');
    if (e.target === modal) {
        closeSettings();
    }
});

document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeSettings();
    }
});

if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeApp);
} else {
    initializeApp();
}

// Áü•ËØÜÂ∫ìÁ≥ªÁªüÂáΩÊï∞
async function loadKnowledgeBase() {
    try {
        console.log('Loading knowledge base...');
        
        // Áü•ËØÜÂ∫ìÊñá‰ª∂ÂàóË°® - ‰∏•Ê†ºÊåâÁÖßdbÊñá‰ª∂Â§π‰∏≠ÁöÑÂÆûÈôÖÊñá‰ª∂
        const knowledgeFiles = [
            '/db/README.md',
            '/db/CALLBACKS.md',
            '/db/CLIENT_OPTIONS.md',
            '/db/ENTITY_SETTINGS.md',
            '/db/MOB_SETTINGS.md',
            '/db/PARTICLES.md',
            '/db/SOUND_NAMES.md',
            '/db/texturepacksREADME.md',
            '/db/all_pages_text.txt'
        ];
        
        knowledgeBase = [];
        knowledgeIndex = {};
        
        for (const file of knowledgeFiles) {
            try {
                console.log(`Attempting to load: ${file}`);
                const response = await fetch(file);
                
                if (response.ok) {
                    const content = await response.text();
                    const fileName = file.split('/').pop();
                    
                    console.log(`Successfully loaded: ${fileName} (${content.length} characters)`);
                    
                    // Ëß£ÊûêÊñá‰ª∂ÂÜÖÂÆπÔºåÊèêÂèñÂÖ≥ÈîÆËØçÂíåÊèèËø∞
                    const keywords = extractKeywords(content, fileName);
                    const description = extractDescription(content, fileName);
                    
                    const knowledgeItem = {
                        fileName: fileName,
                        filePath: file,
                        content: content,
                        keywords: keywords,
                        description: description,
                        lastModified: new Date().toISOString()
                    };
                    
                    knowledgeBase.push(knowledgeItem);
                    
                    // Âª∫Á´ãÁ¥¢Âºï
                    keywords.forEach(keyword => {
                        if (!knowledgeIndex[keyword]) {
                            knowledgeIndex[keyword] = [];
                        }
                        knowledgeIndex[keyword].push(knowledgeItem);
                    });
                    
                    console.log(`Loaded knowledge file: ${fileName} with ${keywords.length} keywords`);
                } else {
                    console.warn(`Failed to load ${file}: ${response.status} ${response.statusText}`);
                }
            } catch (error) {
                console.warn(`Error loading ${file}:`, error);
            }
        }
        
        console.log(`Knowledge base loaded successfully: ${knowledgeBase.length} files`);
        console.log(`Indexed keywords: ${Object.keys(knowledgeIndex).length}`);
        
        // Êõ¥Êñ∞Áü•ËØÜÂ∫ìÁä∂ÊÄÅÊòæÁ§∫
        updateKnowledgeStatus();
        
        // ÊòæÁ§∫Áü•ËØÜÂ∫ìÁä∂ÊÄÅ
        if (knowledgeBase.length > 0) {
            showToast(`Áü•ËØÜÂ∫ìÂ∑≤Âä†ËΩΩ: ${knowledgeBase.length} ‰∏™Êñá‰ª∂`, 'success');
        } else {
            showToast('Áü•ËØÜÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåËØ∑Ê£ÄÊü•Êñá‰ª∂Ë∑ØÂæÑ', 'error');
        }
        
    } catch (error) {
        console.error('Error loading knowledge base:', error);
        showToast('Áü•ËØÜÂ∫ìÂä†ËΩΩÂ§±Ë¥•ÔºåÂ∞Ü‰ΩøÁî®Âü∫Á°ÄÊ®°Âºè', 'warning');
    }
}

function extractKeywords(content, fileName) {
    const keywords = [];
    
    // Âü∫‰∫éÊñá‰ª∂ÂêçÊ∑ªÂä†ÂÖ≥ÈîÆËØç - ÈíàÂØπBloxd.ioÊ∏∏ÊàèÁºñÁ®ã
    if (fileName.includes('README')) keywords.push('readme', 'ÊñáÊ°£', 'ËØ¥Êòé', '‰ªãÁªç', 'bloxd');
    if (fileName.includes('CALLBACKS')) keywords.push('callbacks', 'ÂõûË∞É', '‰∫ã‰ª∂', 'ÁõëÂê¨', 'worldcode', 'world code');
    if (fileName.includes('CLIENT_OPTIONS')) keywords.push('client', 'ÂÆ¢Êà∑Á´Ø', 'ÈÄâÈ°π', 'ÈÖçÁΩÆ', 'ËÆæÁΩÆ', 'bloxd');
    if (fileName.includes('ENTITY_SETTINGS')) keywords.push('entity', 'ÂÆû‰Ωì', 'ËÆæÁΩÆ', 'ÈÖçÁΩÆ', 'ÁîüÁâ©', 'Áâ©‰Ωì');
    if (fileName.includes('MOB_SETTINGS')) keywords.push('mob', 'ÁîüÁâ©', 'ÊÄ™Áâ©', 'ËÆæÁΩÆ', 'ÈÖçÁΩÆ', 'npc');
    if (fileName.includes('PARTICLES')) keywords.push('particles', 'Á≤íÂ≠ê', 'ÁâπÊïà', 'ÊïàÊûú', 'particle');
    if (fileName.includes('SOUND_NAMES')) keywords.push('sound', 'Â£∞Èü≥', 'Èü≥È¢ë', 'Èü≥Êïà', 'ÂêçÁß∞', 'sound names');
    if (fileName.includes('texturepacks')) keywords.push('texture', 'ÊùêË¥®', 'Ë¥¥Âõæ', 'ÁöÆËÇ§', 'ÂåÖ', 'texture pack');
    if (fileName.includes('all_pages_text')) keywords.push('all', 'ÂÖ®ÈÉ®', 'ÂÆåÊï¥', 'ÊñáÊú¨', 'ÂÜÖÂÆπ', 'pages');
    
    // ‰ªéÂÜÖÂÆπ‰∏≠ÊèêÂèñÂÖ≥ÈîÆËØç
    const text = content.toLowerCase();
    
    // BloxdÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
    if (text.includes('bloxd')) keywords.push('bloxd', 'Ê∏∏Êàè', 'bloxd.io');
    if (text.includes('worldbuilder')) keywords.push('worldbuilder', '‰∏ñÁïåÊûÑÂª∫Âô®', 'world builder');
    if (text.includes('worldedit')) keywords.push('worldedit', '‰∏ñÁïåÁºñËæë', 'world edit');
    if (text.includes('block')) keywords.push('block', 'ÊñπÂùó', 'blocks');
    if (text.includes('command')) keywords.push('command', 'ÂëΩ‰ª§', 'cmd');
    if (text.includes('api')) keywords.push('api', 'Êé•Âè£', 'application programming interface');
    if (text.includes('sdk')) keywords.push('sdk', 'ÂºÄÂèëÂåÖ', 'software development kit');
    
    // ‰ª£Á†ÅÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
    if (text.includes('javascript')) keywords.push('javascript', 'js', '‰ª£Á†Å', 'code');
    if (text.includes('function')) keywords.push('function', 'ÂáΩÊï∞', 'ÂäüËÉΩ');
    if (text.includes('callback')) keywords.push('callback', 'ÂõûË∞É', '‰∫ã‰ª∂Â§ÑÁêÜ');
    if (text.includes('event')) keywords.push('event', '‰∫ã‰ª∂', 'ÁõëÂê¨');
    if (text.includes('world')) keywords.push('world', '‰∏ñÁïå', 'world code');
    
    // ÈÄöÁî®ÊäÄÊúØÂÖ≥ÈîÆËØç
    if (text.includes('html')) keywords.push('html');
    if (text.includes('css')) keywords.push('css');
    if (text.includes('json')) keywords.push('json');
    if (text.includes('glb')) keywords.push('glb', '3dÊ®°Âûã');
    if (text.includes('png')) keywords.push('png', 'ÂõæÁâá');
    if (text.includes('jpg')) keywords.push('jpg', 'ÂõæÁâá');
    
    // ÂäüËÉΩÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
    if (text.includes('ÂäüËÉΩ') || text.includes('feature')) keywords.push('ÂäüËÉΩ', 'feature', 'capability');
    if (text.includes('Â∏ÆÂä©') || text.includes('help')) keywords.push('Â∏ÆÂä©', 'help', 'assist');
    if (text.includes('‰ª£Á†Å') || text.includes('code')) keywords.push('‰ª£Á†Å', 'code', 'programming');
    if (text.includes('ÈóÆÈ¢ò') || text.includes('problem')) keywords.push('ÈóÆÈ¢ò', 'problem', 'issue');
    if (text.includes('Ëß£ÂÜ≥') || text.includes('solve')) keywords.push('Ëß£ÂÜ≥', 'solve', 'solution');
    
    // Ê∏∏ÊàèÂºÄÂèëÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
    if (text.includes('minecraft')) keywords.push('minecraft', 'mc', 'Ê∏∏Êàè');
    if (text.includes('player')) keywords.push('player', 'Áé©ÂÆ∂', 'Áî®Êà∑');
    if (text.includes('armour') || text.includes('armor')) keywords.push('armour', 'armor', 'ÁõîÁî≤', 'Ë£ÖÂ§á');
    if (text.includes('sword')) keywords.push('sword', 'Ââë', 'Ê≠¶Âô®');
    if (text.includes('bread')) keywords.push('bread', 'Èù¢ÂåÖ', 'È£üÁâ©');
    if (text.includes('join')) keywords.push('join', 'Âä†ÂÖ•', 'ËøõÂÖ•');
    if (text.includes('plugin')) keywords.push('plugin', 'Êèí‰ª∂', 'Êâ©Â±ï');
    
    // ÁâπÊïàÁõ∏ÂÖ≥ÂÖ≥ÈîÆËØç
    if (text.includes('particle')) keywords.push('particle', 'Á≤íÂ≠ê', 'ÁâπÊïà', 'particles');
    if (text.includes('sound')) keywords.push('sound', 'Â£∞Èü≥', 'Èü≥Êïà', 'audio');
    if (text.includes('texture')) keywords.push('texture', 'ÊùêË¥®', 'Ë¥¥Âõæ', 'ÁöÆËÇ§');
    if (text.includes('effect')) keywords.push('effect', 'ÊïàÊûú', 'ÁâπÊïà');
    
    // ÂéªÈáçÂπ∂ËøîÂõû
    return [...new Set(keywords)];
}

function extractDescription(content, fileName) {
    // Â∞ùËØï‰ªéÊñá‰ª∂ÂºÄÂ§¥ÊèêÂèñÊèèËø∞
    const lines = content.split('\n');
    for (let i = 0; i < Math.min(10, lines.length); i++) {
        const line = lines[i].trim();
        if (line && !line.startsWith('#') && !line.startsWith('//') && line.length > 10) {
            return line.substring(0, 100) + (line.length > 100 ? '...' : '');
        }
    }
    
    // Â¶ÇÊûúÊ≤°ÊúâÊâæÂà∞ÂêàÈÄÇÁöÑÊèèËø∞Ôºå‰ΩøÁî®Êñá‰ª∂Âêç
    return `Áü•ËØÜÂ∫ìÊñá‰ª∂: ${fileName}`;
}

function searchKnowledgeBase(query) {
    if (!knowledgeBase.length) return [];
    
    const queryLower = query.toLowerCase();
    const results = [];
    
    console.log('Searching knowledge base for query:', query);
    console.log('Available keywords:', Object.keys(knowledgeIndex));
    
    // 1. Á≤æÁ°ÆÂÖ≥ÈîÆËØçÂåπÈÖç
    const matchedKeywords = Object.keys(knowledgeIndex).filter(keyword => 
        queryLower.includes(keyword.toLowerCase())
    );
    
    console.log('Matched keywords:', matchedKeywords);
    
    matchedKeywords.forEach(keyword => {
        knowledgeIndex[keyword].forEach(item => {
            if (!results.find(r => r.fileName === item.fileName)) {
                results.push({
                    ...item,
                    relevance: 10, // È´òÁõ∏ÂÖ≥ÊÄß
                    matchType: 'keyword'
                });
            }
        });
    });
    
    // 2. ÂÜÖÂÆπÊêúÁ¥¢
    knowledgeBase.forEach(item => {
        const contentLower = item.content.toLowerCase();
        let relevance = 0;
        
        // ËÆ°ÁÆóÁõ∏ÂÖ≥ÊÄßÂàÜÊï∞
        const words = queryLower.split(/\s+/);
        words.forEach(word => {
            if (word.length > 2) {
                const count = (contentLower.match(new RegExp(word, 'g')) || []).length;
                relevance += count;
            }
        });
        
        if (relevance > 0) {
            const existingResult = results.find(r => r.fileName === item.fileName);
            if (existingResult) {
                existingResult.relevance += relevance;
            } else {
                results.push({
                    ...item,
                    relevance: relevance,
                    matchType: 'content'
                });
            }
        }
    });
    
    // 3. Êô∫ËÉΩÂåπÈÖç - ÂØπ‰∫éÁâπÂÆöÁ±ªÂûãÁöÑÈóÆÈ¢òÔºåÂº∫Âà∂ÂåÖÂê´Áõ∏ÂÖ≥Êñá‰ª∂
    if (queryLower.includes('what can') || queryLower.includes('what do') || queryLower.includes('abilities') || queryLower.includes('capabilities')) {
        // ÂØπ‰∫é"what can you do"Á±ªÂûãÁöÑÈóÆÈ¢òÔºåÂåÖÂê´READMEÂíåCALLBACKS
        const helpFiles = knowledgeBase.filter(item => 
            item.fileName.includes('README') || 
            item.fileName.includes('CALLBACKS') ||
            item.fileName.includes('CLIENT_OPTIONS')
        );
        helpFiles.forEach(item => {
            if (!results.find(r => r.fileName === item.fileName)) {
                results.push({
                    ...item,
                    relevance: 15, // ÊúÄÈ´òÁõ∏ÂÖ≥ÊÄß
                    matchType: 'smart_match'
                });
            }
        });
    }
    
    if (queryLower.includes('code') || queryLower.includes('callback') || queryLower.includes('world') || queryLower.includes('bloxd') || queryLower.includes('block')) {
        // ÂØπ‰∫éBloxd.io‰ª£Á†ÅÁõ∏ÂÖ≥ÈóÆÈ¢òÔºåÂåÖÂê´CALLBACKSÂíåCLIENT_OPTIONS
        const codeFiles = knowledgeBase.filter(item => 
            item.fileName.includes('CALLBACKS') || 
            item.fileName.includes('CLIENT_OPTIONS') ||
            item.fileName.includes('ENTITY_SETTINGS') ||
            item.fileName.includes('MOB_SETTINGS')
        );
        codeFiles.forEach(item => {
            if (!results.find(r => r.fileName === item.fileName)) {
                results.push({
                    ...item,
                    relevance: 15, // ÊúÄÈ´òÁõ∏ÂÖ≥ÊÄß
                    matchType: 'smart_match'
                });
            }
        });
    }
    
    if (queryLower.includes('particle') || queryLower.includes('sound') || queryLower.includes('texture') || queryLower.includes('effect')) {
        // ÂØπ‰∫éÁâπÊïà„ÄÅÂ£∞Èü≥„ÄÅÊùêË¥®Áõ∏ÂÖ≥ÈóÆÈ¢òÔºåÂåÖÂê´Áõ∏ÂÖ≥Êñá‰ª∂
        const effectFiles = knowledgeBase.filter(item => 
            item.fileName.includes('PARTICLES') || 
            item.fileName.includes('SOUND_NAMES') ||
            item.fileName.includes('texturepacksREADME')
        );
        effectFiles.forEach(item => {
            if (!results.find(r => r.fileName === item.fileName)) {
                results.push({
                    ...item,
                    relevance: 15, // ÊúÄÈ´òÁõ∏ÂÖ≥ÊÄß
                    matchType: 'smart_match'
                });
            }
        });
    }
    
    // 4. ÊåâÁõ∏ÂÖ≥ÊÄßÊéíÂ∫èÂπ∂ÈôêÂà∂ÁªìÊûúÊï∞Èáè
    const sortedResults = results
        .sort((a, b) => b.relevance - a.relevance)
        .slice(0, 5); // ÊúÄÂ§öËøîÂõû5‰∏™ÊúÄÁõ∏ÂÖ≥ÁöÑÁªìÊûú
    
    console.log('Final search results:', sortedResults.map(r => ({ fileName: r.fileName, relevance: r.relevance, matchType: r.matchType })));
    
    return sortedResults;
}

function generateKnowledgePrompt(userMessage, knowledgeResults) {
    if (!knowledgeResults.length) {
        return userMessage;
    }
    
    let prompt = `‰Ω†ÊòØ‰∏Ä‰∏™‰∏ì‰∏öÁöÑAIÂä©ÊâãÔºå‰∏ìÈó®Â∏ÆÂä©‰∫∫‰ª¨ÁºñÂÜôÁî®‰∫éBloxd.ioÊ∏∏ÊàèÁöÑ‰ª£Á†Å„ÄÇÂú®Bloxd.io‰∏≠Ôºå‰Ω†ÂèØ‰ª•Âú®‰ª£Á†ÅÂùó‰∏≠ÁºñÂÜô‰ª£Á†ÅÔºåÂè≥ÈîÆÁÇπÂáªËøêË°åÔºåËøòÂèØ‰ª•ÁºñÂÜôÂÆö‰πâÂèØÁºñËæëÂõûË∞ÉÂàóË°®ÁöÑWorld Code„ÄÇ

ÈáçË¶ÅÊåá‰ª§Ôºö
1. 100%Âü∫‰∫é‰ª•‰∏ãÁü•ËØÜÂ∫ìÊñáÊ°£‰ø°ÊÅØÂõûÁ≠îÈóÆÈ¢ò
2. ‰∏ìÈó®ÈíàÂØπBloxd.ioÊ∏∏ÊàèÁºñÁ®ãÊèê‰æõÂ∏ÆÂä©
3. Êèê‰æõÁöÑ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ªÂèØ‰ª•Âú®Bloxd.io‰∏≠ËøêË°å
4. ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ª‰ΩøÁî®‰ª£Á†ÅÂùóÊ†ºÂºè
5. Â¶ÇÊûúÁü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØÔºåËØ∑ÊòéÁ°ÆËØ¥Êòé"Áü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØ"

Áü•ËØÜÂ∫ìÊñáÊ°£‰ø°ÊÅØÔºö
`;
    
    knowledgeResults.forEach((result, index) => {
        prompt += `\n${index + 1}. Êñá‰ª∂: ${result.fileName}
ÊèèËø∞: ${result.description}
ÂÜÖÂÆπÊëòË¶Å: ${result.content.substring(0, 800)}${result.content.length > 800 ? '...' : ''}
`;
    });
    
    prompt += `\nÁî®Êà∑ÈóÆÈ¢ò: ${userMessage}

ÂõûÁ≠îË¶ÅÊ±ÇÔºö
1. ‰∏ìÈó®ÈíàÂØπBloxd.ioÊ∏∏ÊàèÁºñÁ®ãÊèê‰æõÂ∏ÆÂä©
2. Êèê‰æõÁöÑ‰ª£Á†ÅÁ§∫‰æãÂøÖÈ°ªÂèØ‰ª•Âú®Bloxd.io‰∏≠ËøêË°å
3. ‰ª£Á†ÅÁ§∫‰æã‰ΩøÁî®\`\`\`‰ª£Á†ÅÂùó\`\`\`Ê†ºÂºè
4. Â¶ÇÊûúÁü•ËØÜÂ∫ì‰ø°ÊÅØ‰∏çË∂≥ÔºåÊòéÁ°ÆËØ¥Êòé"Áü•ËØÜÂ∫ì‰∏≠Ê≤°ÊúâÁõ∏ÂÖ≥‰ø°ÊÅØ"

ËØ∑ÂºÄÂßãÂõûÁ≠îÔºö`;
    
    return prompt;
}

function updateKnowledgeStatus() {
    // Êõ¥Êñ∞Áü•ËØÜÂ∫ìÁä∂ÊÄÅÊòæÁ§∫
    document.getElementById('knowledgeFileCount').textContent = knowledgeBase.length;
    document.getElementById('knowledgeKeywordCount').textContent = Object.keys(knowledgeIndex).length;
    document.getElementById('knowledgeLastUpdate').textContent = new Date().toLocaleString('zh-CN');
    
    // Êõ¥Êñ∞‰ΩøÁî®ÁªüËÆ°
    document.getElementById('sessionUsage').textContent = knowledgeUsageStats.sessionUsage;
    document.getElementById('totalUsage').textContent = knowledgeUsageStats.totalUsage;
    
    // Êõ¥Êñ∞Êñá‰ª∂ÂàóË°®
    const filesList = document.getElementById('knowledgeFilesList');
    if (knowledgeBase.length > 0) {
        filesList.innerHTML = knowledgeBase.map(item => `
            <div class="knowledge-file-item">
                <div class="file-name">${item.fileName}</div>
                <div class="file-description">${item.description}</div>
                <div class="file-keywords">ÂÖ≥ÈîÆËØç: ${item.keywords.slice(0, 5).join(', ')}</div>
            </div>
        `).join('');
    } else {
        filesList.innerHTML = '<div class="no-files">Ê≤°ÊúâÊâæÂà∞Áü•ËØÜÂ∫ìÊñá‰ª∂</div>';
    }
}

async function testKnowledgeBase() {
    const testQuery = 'ÊµãËØïÁü•ËØÜÂ∫ìÂäüËÉΩ';
    const results = searchKnowledgeBase(testQuery);
    
    if (results.length > 0) {
        showToast(`Áü•ËØÜÂ∫ìÊµãËØïÊàêÂäüÔºÅÊâæÂà∞ ${results.length} ‰∏™Áõ∏ÂÖ≥Êñá‰ª∂`, 'success');
        console.log('Knowledge base test results:', results);
        
        // ÊòæÁ§∫ÊâæÂà∞ÁöÑÊñá‰ª∂
        const fileNames = results.map(r => r.fileName).join(', ');
        addConsoleLine(`ÊµãËØïÊü•ËØ¢: "${testQuery}"`);
        addConsoleLine(`ÊâæÂà∞Êñá‰ª∂: ${fileNames}`);
        addConsoleLine(`Áõ∏ÂÖ≥ÊÄß: ${results.map(r => `${r.fileName}(${r.relevance})`).join(', ')}`);
    } else {
        showToast('Áü•ËØÜÂ∫ìÊµãËØïÂ§±Ë¥•ÔºåÊ≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Êñá‰ª∂', 'warning');
        addConsoleLine(`ÊµãËØïÊü•ËØ¢: "${testQuery}"`);
        addConsoleLine('Ê≤°ÊúâÊâæÂà∞Áõ∏ÂÖ≥Êñá‰ª∂');
        
        // ÊòæÁ§∫ÂèØÁî®ÁöÑÂÖ≥ÈîÆËØç
        const availableKeywords = Object.keys(knowledgeIndex).slice(0, 10);
        addConsoleLine(`ÂèØÁî®ÂÖ≥ÈîÆËØç: ${availableKeywords.join(', ')}...`);
    }
}

function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.textContent = message;
    
    document.body.appendChild(toast);
    
    setTimeout(() => {
        toast.remove();
    }, 3000);
}

// Ë∞ÉËØïÂäüËÉΩ
function showDebugInfo() {
    const debugConsole = document.getElementById('debugConsole');
    debugConsole.innerHTML = '';
    
    // Ê∑ªÂä†Áü•ËØÜÂ∫ìÁä∂ÊÄÅ‰ø°ÊÅØ
    addConsoleLine(`Áü•ËØÜÂ∫ìÁä∂ÊÄÅ: ${knowledgeBase.length} ‰∏™Êñá‰ª∂Â∑≤Âä†ËΩΩ`);
    addConsoleLine(`Á¥¢ÂºïÂÖ≥ÈîÆËØç: ${Object.keys(knowledgeIndex).length} ‰∏™`);
    addConsoleLine(`ÂèØÁî®ÂÖ≥ÈîÆËØç: ${Object.keys(knowledgeIndex).slice(0, 20).join(', ')}...`);
    
    // Ê∑ªÂä†Êñá‰ª∂ÂàóË°®
    knowledgeBase.forEach((item, index) => {
        addConsoleLine(`Êñá‰ª∂ ${index + 1}: ${item.fileName} (${item.keywords.length} ‰∏™ÂÖ≥ÈîÆËØç)`);
    });
    
    // Ê∑ªÂä†‰ΩøÁî®ÁªüËÆ°
    addConsoleLine(`Êú¨Ê¨°‰ºöËØù‰ΩøÁî®: ${knowledgeUsageStats.sessionUsage} Ê¨°`);
    addConsoleLine(`ÊÄª‰ΩøÁî®Ê¨°Êï∞: ${knowledgeUsageStats.totalUsage} Ê¨°`);
}

function addConsoleLine(message) {
    const debugConsole = document.getElementById('debugConsole');
    const line = document.createElement('div');
    line.className = 'console-line';
    line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
    debugConsole.appendChild(line);
    debugConsole.scrollTop = debugConsole.scrollHeight;
}

function clearConsole() {
    const debugConsole = document.getElementById('debugConsole');
    debugConsole.innerHTML = '<div class="console-line">ÊéßÂà∂Âè∞Â∑≤Ê∏ÖÈô§</div>';
}

// ÈáçÂÜôconsole.log‰ª•ÊçïËé∑Êó•Âøó
const originalConsoleLog = console.log;
console.log = function(...args) {
    originalConsoleLog.apply(console, args);
    
    // Â∞ÜÊó•ÂøóÊ∑ªÂä†Âà∞Ë∞ÉËØïÊéßÂà∂Âè∞
    const message = args.map(arg => 
        typeof arg === 'object' ? JSON.stringify(arg, null, 2) : String(arg)
    ).join(' ');
    
    if (message.includes('knowledge') || message.includes('Knowledge') || message.includes('Áü•ËØÜÂ∫ì')) {
        addConsoleLine(message);
    }
};
</script>
</body>
</html>